defaults: &defaults
  working_directory: ~/angular8
  docker:
    - image: circleci/node:latest 

version: 2
jobs:
   build:
     <<: *defaults
     steps:
       - checkout
       - restore_cache:
           key: sudo dependency-cache-{{ checksum "package-lock.json" }}
       - run:
           name: Install npm
           command: npm install
       - save_cache:
           key: sudo dependency-cache-{{ checksum "package-lock.json" }}
           paths:
             - node_modules
       - run:
           name: Install Dependencies
           command: npm install @angular/cli@8.3.20
       - run:
           name: audit fix
           command: npm audit fix --force
       - run:
           name: Build Application
           command: npm run build
       - run:
           name: Zip Application
           command: zip artifact-{{ .Environment.CIRCLE_SHA1 }}.zip dist
           
       - persist_to_workspace: 
           root: dist
           paths: 
             - ./
       - save_cache:
                key: v1-dist-{{ .Environment.CIRCLE_SHA1 }}
                paths:
                    - dist
   deploy:
     <<: *defaults
     steps:
       - checkout
       - run:
           name: check git status -2
           command: git status && git branch
       - restore_cache:
                key: v1-dist-
       - run: 
           name: check
           command: ls -ltr
       - run: 
           name: content
           command: ls -ltr dist
       
       - run: 
           name: copy, commit and push
           command:  ls -ltr &&  git status && git add . && git commit -m "first" && git push origin master
       
workflows:
   version: 2
   build-deploy:
     jobs:
       - build
       - deploy:
           requires:
             - build
           
  
